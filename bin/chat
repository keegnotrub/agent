#!/usr/bin/env zsh

# Usage: chat --help
# Requires: cat, curl, jq, printf

PROMPT="${1}"

case "${PROMPT}" in
    "-h" | "--help")
        echo "usage: chat <prompt>"
        echo "\nUse prompt to provide the agent with text."
        echo "\nText can also be piped to the agent for the prompt."
        echo "   $ echo 'code a factorial method in Ruby' | chat"
        exit 0
        ;;
    "")
        if [[ -p /dev/stdin ]]; then
            PROMPT=$(cat)
        else
            echo "chat: 'requires text for prompt. See 'chat --help'."
            exit 2
        fi
        ;;
esac

printf "üßë‚Äçüíª: %s\n\nü§ñ: " ${PROMPT}

curl -s -N \
  --location 'http://localhost:11434/api/generate' \
  --header 'Content-Type: application/json' \
  --header 'Accept: application/json' \
  --data "{
  \"model\": \"codestral\",
  \"stream\": true,
  \"prompt\": $(printf %s ${PROMPT} | jq -Rs '.')
}" | jq --unbuffered -Rrj \
        'fromjson|.response|if input_line_number == 1 then ltrimstr(" ") else . end'
